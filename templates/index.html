<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Patient Timeline Viewer</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #ffffff;
        }

        h2 {
            margin-top: 0;
        }

        #patientSelect {
            padding: 6px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        #chart {
            width: 100%;
            height: 80vh;
            position: relative;
        }

        #loader {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <h2>Patient Timeline Viewer</h2>
    <label for="patientSelect">Select Patient Timeline:</label>
    <select id="patientSelect"></select>

    <div id="chart">
        <div id="loader">Loading chart...</div>
    </div>

    <script>
        const dropdown = document.getElementById("patientSelect");
        const loader = document.getElementById("loader");

        fetch("/list_csvs")
            .then(response => response.json())
            .then(fileList => {
                fileList.forEach(filename => {
                    const option = document.createElement("option");
                    option.value = filename;
                    option.text = filename.replace("patient_", "").replace("_timeline.csv", "");
                    dropdown.appendChild(option);
                });

                if (fileList.length > 0) {
                    loadAndRender(fileList[0]);
                    dropdown.value = fileList[0];
                }
            });

        dropdown.addEventListener("change", () => {
            loadAndRender(dropdown.value);
        });

        function showLoader() {
            loader.style.display = 'block';
        }

        function hideLoader() {
            loader.style.display = 'none';
        }

        function brighten(hex, factor = 1.12) {
            // Brighten hex color by a factor (default ~12%)
            const num = parseInt(hex.slice(1), 16);
            const r = Math.min(255, Math.floor(((num >> 16) & 0xFF) * factor));
            const g = Math.min(255, Math.floor(((num >> 8) & 0xFF) * factor));
            const b = Math.min(255, Math.floor((num & 0xFF) * factor));
            return `rgb(${r}, ${g}, ${b})`;
        }

        function loadAndRender(filename) {
            showLoader();

            Papa.parse(`/data/${filename}`, {
                download: true,
                header: true,
                complete: function(results) {
                    const data = results.data.filter(d => d.event_time && d.event_type);

                    data.forEach(d => {
                        d.event_time = new Date(d.event_time);
                        d.description = d.description || "";
                        d.source_table = d.source_table || "";
                    });

                    const pastelColors = [
                   '#e67c7c', // muted coral
                    '#e6ac6f', // warm apricot
                    '#e4e06f', // soft gold
                    '#8eea95', // spring green
                    '#57d3e6', // clean aqua
                    '#6596e0', // cool blue
                    '#857ce6', // lavender blue
                    '#df87df', // orchid pink
                    '#efb27f' , // REPLACEMENT: calm sky blue
                    '#9cd9e2', // aqua teal
                    '#b1cc90', // olive green
                    '#e88aa8'  // dusty rose
                    ];


                    const uniqueTypes = [...new Set(data.map(d => d.event_type))];
                    const colorMap = {};
                    uniqueTypes.forEach((type, i) => {
                        colorMap[type] = brighten(pastelColors[i % pastelColors.length]);
                    });

                    const traces = uniqueTypes.map(eventType => {
                        const subset = data.filter(d => d.event_type === eventType);
                        const color = colorMap[eventType];

                        return {
                            x: subset.map(d => d.event_time),
                            y: subset.map(d => d.event_type),
                            mode: 'markers',
                            type: 'scatter',
                            name: eventType,
                            text: subset.map(d =>
                                `<b>${eventType}</b><br>` +
                                `Time: ${d.event_time.toLocaleString()}<br>` +
                                `Desc: ${d.description}<br>` +
                                `Table: ${d.source_table}`
                            ),
                            hoverinfo: 'text',
                            hoverlabel: {
                                bgcolor: "#ffffff",
                                bordercolor: "#ccc",
                                font: { color: "#333" }
                            },
                            marker: {
                                color: color,
                                size: 6,
                                opacity: 0.9,
                                line: { width: 1, color: color }
                            }
                        };
                    });

                    const layout = {
                        title: `Patient Timeline - ${filename}`,
                        xaxis: {
                            title: 'Time',
                            type: 'date',
                            tickformat: "%b %d\n%H:%M"
                        },
                        yaxis: {
                            title: 'Event Type',
                            automargin: true
                        },
                        height: 600,
                        template: 'plotly_white',
                        hovermode: 'closest',
                        legend: {
                            title: { text: 'Event Type' },
                            orientation: "v",
                            x: 1.02
                        },
                        margin: {
                            t: 60,
                            l: 80,
                            r: 200,
                            b: 80
                        }
                    };

                    Plotly.newPlot('chart', traces, layout, { responsive: true }).then(() => {
                        hideLoader();
                    });
                }
            });
        }
    </script>

</body>
</html>
